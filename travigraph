#!/bin/bash

usage() {
    echo "<program> -r username/repo -s <start_build> -e <end_build> -o <output_file.png> [-t <tmpdir>] [-w 600 -h 600] [-cached] [-version]"
    exit 1;
}

while getopts ":c:r:s:e:o:v:t:w:h:" opt; do
  case ${opt} in
    c)
      cached="true"
      ;;
    r)
      repo=${OPTARG}
      ;;
    s)
      sbuild=${OPTARG}
      ;;
    e)
      ebuild=${OPTARG}
      ;;
    o)
      outfile=${OPTARG}
      ;;
    t)
      tmpdir=${OPTARG}/
      ;;
    w)
      width=${OPTARG}
      ;;
    h)
      height=${OPTARG}
      ;;
    v)
      cat VERSION
      exit 0
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2 
      exit 1
      ;;
  esac
done

if [ -z "${sbuild}" ] || [ -z "${ebuild}" ] || [ -z "${outfile}" ]  || [ -z "${repo}" ]; then
    usage
    exit 1
fi

mkdir -p ${tmpdir}
for i in `seq $sbuild 25 $ebuild`; do
    echo Processing build $i;
    if [[ ! -f ${tmpdir}$i.parsed.json || $cached -ne "true" ]]; then
        travis raw --json /repos/${repo}/builds?after_number=$i | Rscript --slave --vanilla regularize_json.R > ${tmpdir}$i.parsed.json;
    fi
done;

Rscript --slave --vanilla merge_json.R ${tmpdir}*parsed.json > ${tmpdir}out.json;
Rscript --slave --vanilla process.R ${tmpdir}out.json ${tmpdir}output.csv
Rscript --slave --vanilla plot.R ${tmpdir}output.csv $outfile ${width} ${height}
echo "Done"
